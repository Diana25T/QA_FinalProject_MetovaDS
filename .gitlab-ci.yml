# .gitlab-ci.yml
image: python:3.11

variables:
  ALLURE_RESULTS: "allure-results"
  ALLURE_REPORT: "public"

stages:
  - setup
  - test
  - report
  - deploy

# 1. SETUP
setup-environment:
  stage: setup
  script:
    - echo "=== НАСТРОЙКА ОКРУЖЕНИЯ ==="
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - apt-get update && apt-get install -y wget unzip
    - echo "Окружение готово!"

# 2. TEST - API тесты
test-api:
  stage: test
  script:
    - echo "=== API ТЕСТЫ ==="
    - mkdir -p $ALLURE_RESULTS
    - python -m pytest tests/ -m api -v --alluredir=$ALLURE_RESULTS || echo "API тесты завершены"
  artifacts:
    paths:
      - $ALLURE_RESULTS/
    expire_in: 1 week

# 3. TEST - UI тесты
test-ui:
  stage: test
  script:
    - echo "=== UI ТЕСТЫ ==="
    - mkdir -p $ALLURE_RESULTS
    - python -m pytest tests/ -m ui -v --alluredir=$ALLURE_RESULTS || echo "UI тесты завершены"
  artifacts:
    paths:
      - $ALLURE_RESULTS/
    expire_in: 1 week

# 4. REPORT - Allure отчет (ИСПРАВЛЕНО: используем Java образ)
generate-report:
  stage: report
  image: openjdk:11-slim  # ← ВАЖНО: Java образ для Allure!
  script:
    - echo "=== ALLURE ОТЧЕТ ==="

    # Устанавливаем Allure CLI
    - apt-get update && apt-get install -y wget unzip

    # Скачиваем и устанавливаем Allure
    - wget https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.zip
    - unzip allure-2.29.0.zip -d /opt/
    - ln -s /opt/allure-2.29.0/bin/allure /usr/bin/allure

    # Проверяем установку
    - allure --version

    # Генерируем отчет
    - allure generate $ALLURE_RESULTS -o $ALLURE_REPORT --clean

    - echo "✅ Allure отчет создан"
    - ls -la $ALLURE_REPORT/

  artifacts:
    paths:
      - $ALLURE_REPORT/
    expire_in: 30 days
  only:
    - main

# 5. DEPLOY - GitLab Pages
pages:
  stage: deploy
  script:
    - echo "=== ПУБЛИКАЦИЯ ==="
    - mkdir -p public
    - cp -r $ALLURE_REPORT/* public/ 2>/dev/null || echo "Копирование отчета"
    - echo '<html><head><meta http-equiv="refresh" content="0; url=index.html"></head><body><h1>Allure Report</h1><p>Redirecting...</p></body></html>' > public/index.html
    - echo "✅ Отчет опубликован!"
  artifacts:
    paths:
      - public
  only:
    - main