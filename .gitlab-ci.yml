stages:
  - prepare
  - test_api
  - test_ui

variables:
  PYTHONPATH: "${CI_PROJECT_DIR}"

cache:
  paths:
    - venv/
    - .cache/pip/
  key: "${CI_COMMIT_REF_SLUG}"

prepare:
  stage: prepare
  image: python:3.11-slim
  script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  artifacts:
    paths:
      - venv/
    expire_in: 1 hour

api_tests:
  stage: test_api
  image: python:3.11-slim
  needs: ["prepare"]
  variables:
    BASE_URL: "https://tandoor.dev"  # ← Укажите правильный URL для CI
    TANDOOR_TOKEN: $TANDOOR_TOKEN    # ← Это важно!
  before_script:
    - source venv/bin/activate
  script:
    - echo "=== Проверка переменных окружения в CI ==="
    - echo "BASE_URL: $BASE_URL"
    - echo "TANDOOR_TOKEN установлена: ${#TANDOOR_TOKEN} символов"
    - echo "=== Запуск API тестов ==="
    - python -m pytest tests/ -m api -v --alluredir=allure-results
  artifacts:
    when: always
    paths:
      - allure-results/
    expire_in: 1 week

ui_tests:
  stage: test_ui
  image: python:3.11-slim
  needs: ["prepare"]
  services:
    - name: selenium/standalone-chrome:latest
      alias: selenium__standalone-chrome
  variables:
    BASE_URL: "https://tandoor.dev"  # ← Тот же URL
    TANDOOR_TOKEN: $TANDOOR_TOKEN    # ← И здесь тоже
    SELENIUM_HOST: selenium__standalone-chrome
  before_script:
    - source venv/bin/activate
  script:
    - echo "=== Запуск UI тестов ==="
    - echo "SELENIUM_HOST: $SELENIUM_HOST"
    - python -m pytest tests/ -m ui -v --alluredir=allure-results
  artifacts:
    when: always
    paths:
      - allure-results/
    expire_in: 1 week