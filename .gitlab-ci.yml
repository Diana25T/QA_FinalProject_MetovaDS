# Используем образ Python для большинства этапов
image: python:3.11

# Переменные, которые будут использоваться в пайплайне
variables:
  BASE_URL: $BASE_URL
  TANDOOR_TOKEN: $TANDOOR_TOKEN
  TANDOOR_USERNAME: $TANDOOR_USERNAME
  TANDOOR_PASSWORD: $TANDOOR_PASSWORD
  POSTGRES_PASSWORD: $POSTGRES_PASSWORD
  SECRET_KEY: $SECRET_KEY
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  SELENIUM_REMOTE_URL: "http://selenium__standalone-chrome:4444/wd/hub"  # Для использования services
  CI: "true"  # Обязательно установите это для фикстуры
  DOCKER_COMPOSE_VERSION: "1.29.2"

# Кэширование зависимостей Python для ускорения сборок
cache:
  paths:
    - .cache/pip
    - venv/
    - .wdm/

# Сервис Docker-in-Docker для запуска контейнеров
services:
  - docker:dind
  - selenium/standalone-chrome:latest

# Этапы выполнения пайплайна
stages:
  - prepare
  - build
  - test_api
  - test_ui
  - report
  - cleanup

# Этап 1: Установка зависимостей и подготовки окружения
prepare_environment:
  stage: prepare
  script:
    # Устанавливаем Java (требуется для Allure)
    - apt-get update
    - apt-get install -y default-jre-headless wget unzip curl gnupg

    # Устанавливаем Docker Compose
    - curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    - chmod +x /usr/local/bin/docker-compose
    - docker-compose --version

    # Создаем виртуальное окружение Python
    - python -m venv venv
    - source venv/bin/activate

    # Обновляем pip и устанавливаем зависимости
    - pip install --upgrade pip
    - pip install --cache-dir=$PIP_CACHE_DIR -r requirements.txt
    - pip install pytest pytest-html allure-pytest requests selenium webdriver-manager

    # Устанавливаем Allure командной строки
    - wget -q "https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-2.24.1.tgz"
    - tar -xzf allure-2.24.1.tgz -C /opt/
    - ln -sf /opt/allure-2.24.1/bin/allure /usr/local/bin/allure
    - allure --version

  artifacts:
    paths:
      - venv/
      - /opt/allure-2.24.1/
    expire_in: 1 hour

# Этап 2: Сборка и запуск приложения
build_and_deploy:
  stage: build
  script:
    # Очищаем предыдущие контейнеры
    - docker-compose down -v --remove-orphans 2>/dev/null || true

    # Создаем .env файл с необходимыми переменными
    - |
      cat > .env <<EOF
      SECRET_KEY=${SECRET_KEY}
      DEBUG=1
      ALLOWED_HOSTS=*,localhost,web_recipes,127.0.0.1,0.0.0.0
      CSRF_TRUSTED_ORIGINS=http://localhost,http://web_recipes
      DB_ENGINE=django.db.backends.postgresql
      POSTGRES_HOST=db_recipes
      POSTGRES_PORT=5432
      POSTGRES_USER=djangodb
      POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      POSTGRES_DB=djangodb
      EOF

    # Запускаем приложение
    - docker-compose up -d

    # Ожидаем готовности базы данных
    - |
      MAX_RETRIES=30
      for i in $(seq 1 $MAX_RETRIES); do
        echo "Попытка $i/$MAX_RETRIES: Проверка готовности БД..."
        if docker-compose exec -T db_recipes pg_isready -U djangodb; then
          echo "✓ База данных готова"
          break
        fi
        sleep 2
        if [ $i -eq $MAX_RETRIES ]; then
          echo "❌ База данных не стала доступна за $MAX_RETRIES попыток"
          exit 1
        fi
      done

    # Проверяем готовность приложения
    - |
      until curl -s -f -o /dev/null http://web_recipes:80; do
        echo "Ожидается старт приложения..."
        sleep 5
      done
      echo "✓ Приложение стало доступно."

  artifacts:
    paths:
      - .env
      - docker-compose.yml
    expire_in: 1 day

# Этап 3: Запуск API тестов
run_api_tests:
  stage: test_api
  script:
    - source venv/bin/activate
    - export APP_URL="http://web_recipes:80"
    - python -m pytest tests/api_tests/ -v --alluredir=allure-results-api --junitxml=junit-api.xml

  artifacts:
    paths:
      - allure-results-api/
      - junit-api.xml
    reports:
      junit: junit-api.xml

# Этап 4: Запуск UI тестов
run_ui_tests:
  stage: test_ui
  script:
    - source venv/bin/activate
    - export BASE_URL="http://web_recipes:80"
    - python -m pytest tests/ui_tests/ -v --alluredir=allure-results-ui --junitxml=junit-ui.xml

  artifacts:
    paths:
      - allure-results-ui/
      - junit-ui.xml
    reports:
      junit: junit-ui.xml

# Этап 5: Генерация общего отчета Allure
generate_allure_report:
  stage: report
  script:
    - echo "Генерация объединённого Allure отчета..."
    - mkdir -p allure-results-combined
    - cp -r allure-results-api/* allure-results-combined/ 2>/dev/null || true
    - cp -r allure-results-ui/* allure-results-combined/ 2>/dev/null || true
    - allure generate allure-results-combined --clean -o public

  artifacts:
    paths:
      - public/
    expire_in: 30 days

# Этап 6: Остановка контейнеров
cleanup_containers:
  stage: cleanup
  script:
    - docker-compose down -v || true
    - echo "Очистка завершена"
  when: always

# Этап 7: Публикация отчета на GitLab Pages
publish_report_to_pages:
  stage: report
  script:
    - echo "Публикация Allure отчета на GitLab Pages..."
    - mv public public_html || true
  artifacts:
    paths:
      - public
  only:
    - main