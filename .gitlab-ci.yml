stages:
  - test_api
  - test_ui
  - report

variables:
  BASE_URL: "http://tandoor:80"
  SELENIUM_HOST: "selenium"

# Job 1: API —Ç–µ—Å—Ç—ã
api_tests:
  stage: test_api
  image: python:3.11-slim
  services:  # ‚Üê –ó–î–ï–°–¨ –î–û–ë–ê–í–õ–Ø–ï–ú TANDOOR
    - name: vabene1111/recipes:latest
      alias: tandoor
  script:
    - echo "üöÄ –ó–∞–ø—É—Å–∫ API —Ç–µ—Å—Ç–æ–≤..."
    - pip install -r requirements.txt
    - echo "BASE_URL = $BASE_URL"
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Tandoor
    - timeout 30 bash -c 'until curl -s http://tandoor:80 > /dev/null; do sleep 2; echo "‚è≥ –ñ–¥–µ–º Tandoor..."; done'
    - pytest tests/ -m api -v --alluredir=allure-results

# Job 2: UI —Ç–µ—Å—Ç—ã
ui_tests:
  stage: test_ui
  image: python:3.11-slim
  services:  # ‚Üê –ó–î–ï–°–¨ –î–û–ë–ê–í–õ–Ø–ï–ú TANDOOR –ò SELENIUM
    - name: vabene1111/recipes:latest
      alias: tandoor
    - name: selenium/standalone-chrome:latest
      alias: selenium
  script:
    - echo "üöÄ –ó–∞–ø—É—Å–∫ UI —Ç–µ—Å—Ç–æ–≤..."
    - pip install -r requirements.txt
    - echo "BASE_URL = $BASE_URL"
    - echo "SELENIUM_HOST = $SELENIUM_HOST"
    # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
    - sleep 20
    - pytest tests/ -m ui -v --alluredir=allure-results

# Job 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
generate_report:
  stage: report
  image: frankescobar/allure-docker-service
  script:
    - allure generate allure-results --clean -o public
  artifacts:
    paths:
      - public