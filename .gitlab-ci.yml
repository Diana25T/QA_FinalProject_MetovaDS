# .gitlab-ci.yml
image: python:3.11

variables:
  ALLURE_RESULTS: "allure-results"
  ALLURE_REPORT: "public"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - .wdm/
  key: "${CI_COMMIT_REF_SLUG}"

stages:
  - setup
  - test
  - report
  - deploy

# 1. SETUP - Подготовка окружения
setup-environment:
  stage: setup
  script:
    - echo "=== НАСТРОЙКА ОКРУЖЕНИЯ ==="
    - echo "Пользователь: $GITLAB_USER_LOGIN"
    - echo "Ветка: $CI_COMMIT_BRANCH"

    # Установка зависимостей
    - pip install --upgrade pip
    - pip install -r requirements.txt

    # Установка дополнительных пакетов для тестов
    - pip install allure-pytest pytest-html

    # Для UI тестов установим системные зависимости
    - apt-get update && apt-get install -y wget unzip

    - echo "Окружение готово к тестированию!"

# 2. TEST - API тесты
test-api:
  stage: test
  script:
    - echo "=== ЗАПУСК API ТЕСТОВ ==="
    - echo "Этот job запускает API тесты"

    # Проверяем наличие директории для результатов
    - mkdir -p $ALLURE_RESULTS

    # Запускаем API тесты (помеченные как @pytest.mark.api)
    - python -m pytest tests/ -m api -v --alluredir=$ALLURE_RESULTS || echo "API тесты завершены"

    # Или конкретные файлы
    # - python -m pytest tests/test_api_client.py tests/test_meal_plan.py -v --alluredir=$ALLURE_RESULTS

    - echo "API тестирование завершено"

  artifacts:
    when: always
    paths:
      - $ALLURE_RESULTS/
    expire_in: 1 week

# 3. TEST - UI тесты (отдельный job для параллельного запуска)
test-ui:
  stage: test
  script:
    - echo "=== ЗАПУСК UI ТЕСТОВ ==="
    - echo "Этот job запускает UI тесты с Selenium"
    - echo "После установки зависимостей, запускаем UI тесты"

    # Устанавливаем зависимости
    - pip install -r requirements.txt

    # Устанавливаем Chrome драйвер через webdriver-manager
    - pip install webdriver-manager

    # Создаем директорию для скриншотов
    - mkdir -p screenshots

    # Запускаем UI тесты (помеченные как @pytest.mark.ui)
    - python -m pytest tests/ -m ui -v --alluredir=$ALLURE_RESULTS || echo "UI тесты завершены"

    # Или конкретные файлы
    # - python -m pytest tests/test_ui.py tests/test_login_page.py -v --alluredir=$ALLURE_RESULTS

    - echo "UI тестирование завершено"
    - echo "Этот job занимает больше времени из-за запуска браузера"
    - sleep 5  # имитация дополнительного времени

  artifacts:
    when: always
    paths:
      - $ALLURE_RESULTS/
      - screenshots/
    expire_in: 1 week

# 4. REPORT - Генерация Allure отчетов
generate-report:
  stage: report
  script:
    - echo "=== ГЕНЕРАЦИЯ ALLURE ОТЧЕТОВ ==="
    - echo "Этот job генерирует отчеты из результатов тестов"

    # Устанавливаем Allure
    - pip install allure-pytest

    # Генерируем отчет
    - allure generate $ALLURE_RESULTS -o $ALLURE_REPORT --clean

    - echo "Отчет сгенерирован в папке $ALLURE_REPORT"
    - ls -la $ALLURE_REPORT/

  artifacts:
    paths:
      - $ALLURE_REPORT/
    expire_in: 30 days
  # Только для main ветки
  only:
    - main

# 5. DEPLOY - Публикация отчетов на GitLab Pages
deploy-pages:
  stage: deploy
  script:
    - echo "=== ПУБЛИКАЦИЯ ОТЧЕТОВ ==="
    - echo "Этот job публикует отчеты на GitLab Pages из ветки $CI_COMMIT_BRANCH"

    # Копируем отчет в public директорию
    - cp -r $ALLURE_REPORT/* public/ 2>/dev/null || echo "Создаем public директорию"
    - mkdir -p public
