# .gitlab-ci.yml
image: python:3.11

variables:
  ALLURE_RESULTS: "allure-results"
  ALLURE_REPORT: "public"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip

stages:
  - setup
  - test
  - report
  - deploy

# 1. SETUP - Подготовка окружения
setup-environment:
  stage: setup
  script:
    - echo "=== НАСТРОЙКА ОКРУЖЕНИЯ ==="
    - pip install --upgrade pip
    - pip install --cache-dir $PIP_CACHE_DIR -r requirements.txt
    - pip install allure-pytest pytest-html
    - apt-get update && apt-get install -y wget unzip
    - echo "Окружение готово к тестированию!"

# 2. TEST - API тесты
test-api:
  stage: test
  script:
    - echo "=== ЗАПУСК API ТЕСТОВ ==="
    - echo "Этот job запускает API тесты"
    - mkdir -p $ALLURE_RESULTS
    - python -m pytest tests/ -m api -v --alluredir=$ALLURE_RESULTS || echo "API тесты завершены"
    - echo "API тестирование завершено"
  artifacts:
    when: always
    paths:
      - $ALLURE_RESULTS/
    expire_in: 1 week

# 3. TEST - UI тесты
test-ui:
  stage: test
  script:
    - echo "=== ЗАПУСК UI ТЕСТОВ ==="
    - echo "Этот job запускает UI тесты с Selenium"
    - echo "После установки зависимостей, запускаем UI тесты"
    - pip install --cache-dir $PIP_CACHE_DIR -r requirements.txt
    - pip install webdriver-manager
    - mkdir -p screenshots
    - python -m pytest tests/ -m ui -v --alluredir=$ALLURE_RESULTS || echo "UI тесты завершены"
    - echo "UI тестирование завершено"
    - echo "Этот job занимает больше времени из-за запуска браузера"
    - sleep 5
  artifacts:
    when: always
    paths:
      - $ALLURE_RESULTS/
      - screenshots/
    expire_in: 1 week

# 4. REPORT - Генерация Allure отчетов
generate-report:
  stage: report
  image: openjdk:11  # Allure требует Java
  before_script:
    - apt-get update && apt-get install -y wget unzip python3 python3-pip
  script:
    - echo "=== ГЕНЕРАЦИЯ ALLURE ОТЧЕТОВ ==="
    - echo "Этот job генерирует отчеты из результатов тестов"

    # Устанавливаем Allure CLI
    - wget https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.zip
    - unzip allure-2.29.0.zip -d /opt/
    - ln -s /opt/allure-2.29.0/bin/allure /usr/bin/allure
    - allure --version

    # Генерируем отчет
    - echo "Генерация Allure отчета..."
      - allure generate $ALLURE_RESULTS -o $ALLURE_REPORT --clean
      - echo "Отчет создан"
      - ls -la $ALLURE_REPORT/
  artifacts:
    paths:
      - $ALLURE_REPORT/
    expire_in: 30 days
  only:
    - main

# 5. DEPLOY - Публикация отчетов на GitLab Pages
deploy-pages:
  stage: deploy
  script:
    - echo "=== ПУБЛИКАЦИЯ ОТЧЕТОВ ==="
    - echo "Этот job публикует отчеты на GitLab Pages из ветки $CI_COMMIT_BRANCH"

    # Создаем директорию и копируем отчет
    - mkdir -p public
    - cp -r $ALLURE_REPORT/* public/ 2>/dev/null || echo "Копирование отчетов"

    - echo "Готово! Отчеты опубликованы на GitLab Pages"
    - echo "Ссылка: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME/"

  artifacts:
    paths:
      - public
  only:
    - main