# .gitlab-ci.yml
image: python:3.11-slim  # ЛУЧШЕ ИСПОЛЬЗОВАТЬ SLIM

variables:
  ALLURE_RESULTS: "allure-results"
  ALLURE_REPORT: "public"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - .wdm/
  key: "${CI_COMMIT_REF_SLUG}"
  policy: pull-push

stages:
  - setup
  - test
  - report
  - deploy

# 1. SETUP - Подготовка окружения
setup-environment:
  stage: setup
  script:
    - echo "=== НАСТРОЙКА ОКРУЖЕНИЯ ==="
    - mkdir -p $PIP_CACHE_DIR
    - pip install --upgrade pip
    - pip install --cache-dir $PIP_CACHE_DIR -r requirements.txt
    - echo " Зависимости установлены и закэшированы в $PIP_CACHE_DIR"
    - pip install allure-pytest pytest requests
    - pip install --cache-dir $PIP_CACHE_DIR allure-pytest pytest-html
    - apt-get update && apt-get install -y wget unzip
    - pip list | grep -E "pytest|allure|requests"
    - echo "Окружение готово к тестированию!"
  cache:
    paths:
      - .cache/pip
    policy: push

# 2. TEST - API тесты (ИСПРАВЛЕНО: убрал лишние кавычки)
test-api:
  stage: test
  needs: ["setup-environment"]  # ИСПРАВЛЕНО
  script:
    - echo "=== ЗАПУСК API ТЕСТОВ ==="
    - echo "Этот job запускает API тесты"

    # Устанавливаем пакеты ИЗ КЭША
    - echo "Установка из кэша..."
    - pip install --cache-dir $PIP_CACHE_DIR -r requirements.txt

    - mkdir -p $ALLURE_RESULTS
    - python -m pytest tests/ -m api -v --alluredir=$ALLURE_RESULTS || echo "API тесты завершены"
    - echo "API тестирование завершено"
  artifacts:
    when: always
    paths:
      - $ALLURE_RESULTS/
    expire_in: 1 week

# 3. TEST - UI тесты (ИСПРАВЛЕННАЯ ВЕРСИЯ)
test-ui:
  stage: test
  needs: ["setup-environment"]  # ИСПРАВЛЕНО: убрал artifacts: true
  script:
    - echo "=== ЗАПУСК UI ТЕСТОВ ==="
    - echo "Этот job запускает UI тесты с Selenium"

    # Устанавливаем Chrome
    - echo "Устанавливаем Chrome..."
    - apt-get update
    - apt-get install -y wget gnupg
    - wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
    - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
    - apt-get update  # ДОБАВИТЬ ЭТУ СТРОКУ!
    - apt-get install -y google-chrome-stable

    # Проверяем Chrome
    - echo "Chrome версия: $(google-chrome --version)"

    # Очищаем кэш webdriver-manager
    - rm -rf /root/.wdm 2>/dev/null || true

    - echo "После установки зависимостей, запускаем UI тесты"
    - pip install --cache-dir $PIP_CACHE_DIR -r requirements.txt
    - pip install webdriver-manager  # ДОБАВИТЬ!

    - mkdir -p screenshots
    - mkdir -p $ALLURE_RESULTS

    # Запускаем тесты
    - CI=true python -m pytest tests/ -m ui -v --alluredir=$ALLURE_RESULTS || echo "UI тесты завершены"
    - echo "UI тестирование завершено"
  artifacts:
    when: always
    paths:
      - $ALLURE_RESULTS/
      - screenshots/
    expire_in: 1 week

# 4. REPORT - Генерация Allure отчетов
generate-report:
  stage: report
  needs: ["test-api", "test-ui"]
  script:
    - echo "=== ГЕНЕРАЦИЯ ALLURE ОТЧЕТОВ ==="
    - echo "Этот job генерирует отчеты из результатов тестов"

    # Устанавливаем Allure CLI
    - apt-get update
    - apt-get install -y default-jre-headless wget unzip
    - wget https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.zip
    - unzip allure-2.29.0.zip -d /opt/
    - ln -s /opt/allure-2.29.0/bin/allure /usr/bin/allure
    - allure --version

    # Генерируем отчет
    - allure generate $ALLURE_RESULTS -o $ALLURE_REPORT --clean

    - echo "Отчет сгенерирован в папке $ALLURE_REPORT"
    - ls -la $ALLURE_REPORT/

  artifacts:
    paths:
      - $ALLURE_REPORT/
    expire_in: 30 days
  only:
    - main

# 5. DEPLOY - Публикация отчетов на GitLab Pages
pages:
  stage: deploy
  needs: ["generate-report"]
  script:
    - echo "=== ПУБЛИКАЦИЯ ОТЧЕТОВ НА GITLAB PAGES ==="
    - mkdir -p public
    - cp -r $ALLURE_REPORT/* public/ 2>/dev/null || echo "Копирование отчетов"
    - echo "Отчеты готовы для GitLab Pages"
  artifacts:
    paths:
      - public
  only:
    - main