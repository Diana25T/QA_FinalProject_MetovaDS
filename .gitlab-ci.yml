# .gitlab-ci.yml
# Используем образ Python
image: python:3.11

# Переменные, которые будут использоваться в пайплайне
variables:
  BASE_URL: $BASE_URL
  TANDOOR_TOKEN: $TANDOOR_TOKEN
  TANDOOR_USERNAME: $TANDOOR_USERNAME
  TANDOOR_PASSWORD: $TANDOOR_PASSWORD
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Кэширование зависимостей Python для ускорения сборок
cache:
  paths:
    - .cache/pip
    - venv/
    - .wdm/

# Определяем этапы выполнения пайплайна
stages:
  - prepare
  - test_api
  - test_ui
  - report
  - deploy

# Этап 1: Подготовка зависимостей и окружения
prepare_dependencies:
  stage: prepare
  script:
    # Устанавливаем Java (требуется для Allure)
    - apt-get update
    - apt-get install -y default-jre-headless wget unzip curl gnupg

    # Создаем виртуальное окружение Python
    - python -m venv venv
    - source venv/bin/activate

    # Обновляем pip и устанавливаем зависимости
    - pip install --upgrade pip
    - pip install --cache-dir=$PIP_CACHE_DIR -r requirements.txt

    # Устанавливаем Allure командной строки
    - wget -q "https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-2.24.1.tgz"
    - tar -xzf allure-2.24.1.tgz -C /opt/
    - ln -sf /opt/allure-2.24.1/bin/allure /usr/local/bin/allure
    - allure --version

    # Проверяем что Java установлена
    - java --version

    # Предварительная загрузка ChromeDriver через webdriver-manager
    - python -c "from webdriver_manager.chrome import ChromeDriverManager; ChromeDriverManager().install()"

  artifacts:
    paths:
      - venv/
    expire_in: 1 hour
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Этап 2: Запуск API тестов
test_api:
  stage: test_api
  needs:
    - prepare_dependencies
  script:
    # Активируем виртуальное окружение
    - source venv/bin/activate

    # Выводим информацию о переменных
    - echo "Запускаем API тесты на $BASE_URL"
    - echo "Пользователь:$TANDOOR_USERNAME"
    - echo "Bearer Token (первые 10 символов):${TANDOOR_TOKEN:0:10}..."

    # Запускаем API тесты с маркировкой 'api' и создаем JUnit отчет
    - pytest tests/ -m api -v --alluredir=allure-results-api --junitxml=junit-api.xml

  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - allure-results-api/
      - junit-api.xml
    reports:
      junit: junit-api.xml
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Этап 3: Запуск UI тестов
test_ui:
  stage: test_ui
  needs:
    - prepare_dependencies
  before_script:
    # Устанавливаем Google Chrome и зависимости
    # Устанавливаем Google Chrome (современный способ без apt-key)
    - apt-get update
    - apt-get install -y --no-install-recommends wget gnupg2 curl unzip xvfb libnss3 libgconf-2-4 libxss1 libasound2

    # Устанавливаем Chrome через официальный репозиторий (новый метод)
    - wget -q -O /usr/share/keyrings/google-chrome-keyring.gpg https://dl.google.com/linux/linux_signing_key.pub
    - echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
    - apt-get update
    - apt-get install -y --no-install-recommends google-chrome-stable

    # Проверяем версию Chrome
    - echo "Установлен Chrome:"
    - google-chrome --version

    # Устанавливаем зависимости для Xvfb
    - apt-get install -y xvfb x11-utils

    # Запускаем виртуальный дисплей
    - Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &
    - sleep 3

    # Проверяем Xvfb
    - xdpyinfo -display :99 >/dev/null 2>&1 && echo "Xvfb запущен" || echo "Xvfb не запущен"

  script:
      # Активируем виртуальное окружение
    - source venv/bin/activate

    # Устанавливаем переменную окружения для Chrome
    - export DISPLAY=:99

    # Создаем директории для артефактов
    - mkdir -p allure-results-ui screenshots-output

    # Запускаем UI тесты
    - echo "Запускаем UI тесты на дисплее $DISPLAY"
    - pytest tests/ -m ui -v --alluredir=allure-results-ui --junitxml=junit-ui.xml || true

    # Копируем скриншоты если они есть
    - |
      if [ -d "screenshots" ]; then
        echo "Найдены скриншоты, копируем..."
        cp -r screenshots/* screenshots-output/ 2>/dev/null || true
      fi
      
      # Проверяем что отчеты созданы
      echo "Проверка созданных файлов:"
      ls -la allure-results-ui/ 2>/dev/null || echo "Директория allure-results-ui не создана"
      ls -la screenshots-output/ 2>/dev/null || echo "Директория screenshots-output не создана"

  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - allure-results-ui/
      - screenshots-output/
      - junit-ui.xml
    reports:
      junit: junit-ui.xml
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Этап 4: Генерация отчета Allure
generate_allure_report:
  stage: report
  needs:
    - job: test_api
      artifacts: true
    - job: test_ui
      artifacts: true
  script:
    - echo "Генерация объединенного Allure отчета..."

    # Проверяем что Java установлена
    - java --version
    - allure --version

    # Объединяем результаты API и UI тестов
    - mkdir -p allure-results-combined

    # Копируем результаты API тестов
    - if [ -d "allure-results-api" ]; then
        echo "Копируем результаты API тестов..."
        cp -r allure-results-api/* allure-results-combined/ 2>/dev/null || true
      else
        echo "Директория allure-results-api не найдена"
      fi

    # Копируем результаты UI тестов
    - if [ -d "allure-results-ui" ]; then
        echo "Копируем результаты UI тестов..."
        cp -r allure-results-ui/* allure-results-combined/ 2>/dev/null || true
      else
        echo "Директория allure-results-ui не найдена"
      fi

    # Генерируем HTML отчет
    - echo "Содержимое allure-results-combined:"
    - find allure-results-combined -type f 2>/dev/null | head -5 || echo "Директория пуста"

    - allure generate allure-results-combined --clean -o public

    # Проверяем что отчет создан
    - echo "Содержимое public:"
    - ls -la public/

  artifacts:
    paths:
      - public/
    expire_in: 30 days
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Этап 5: Публикация отчета на GitLab Pages
pages:
  stage: deploy
  dependencies:
    - generate_allure_report
  script:
    - echo "Публикация Allure отчета на GitLab Pages..."
    - echo "Отчет будет доступен по адресу:https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME"
  artifacts:
    paths:
      - public
  only:
    - main  # Публикуем отчет только для ветки main