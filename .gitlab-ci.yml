stages:
  - prepare
  - test_api
  - test_ui
  - generate_report
  - deploy_pages

variables:
  BASE_URL: "http://tandoor:80"  # –í–∞—à –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç 80
  SELENIUM_HOST: "selenium"
  PYTHON_VERSION: "3.11"
  ALLURE_VERSION: "2.29.0"

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - venv/
    - .pytest_cache/
    - .cache/pip/
  policy: pull-push

# –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤—Å–µ—Ö jobs
.default_job: &default_job
  image: python:${PYTHON_VERSION}-slim
  before_script:
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - apt-get update && apt-get install -y curl wget
    - python --version
    - pip install --upgrade pip setuptools wheel

# ------------------------------------------------------------
# 1. –ü–û–î–ì–û–¢–û–í–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø
# ------------------------------------------------------------
prepare_environment:
  stage: prepare
  <<: *default_job
  script:
    - echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    # –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    - python -m venv venv
    - source venv/bin/activate
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - pip install -r requirements.txt
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Allure CLI
    - wget https://github.com/allure-framework/allure2/releases/download/${ALLURE_VERSION}/allure-${ALLURE_VERSION}.tgz
    - tar -xzf allure-${ALLURE_VERSION}.tgz -C /opt/
    - ln -s /opt/allure-${ALLURE_VERSION}/bin/allure /usr/local/bin/allure
    - allure --version
    - echo "‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ"
  artifacts:
    paths:
      - venv/
      - /opt/allure-${ALLURE_VERSION}/
    expire_in: 1 hour

# ------------------------------------------------------------
# 2. API –¢–ï–°–¢–´
# ------------------------------------------------------------
api_tests:
  stage: test_api
  <<: *default_job
  services:
    - name: vabene1111/recipes:latest
      alias: tandoor
  variables:
    BASE_URL: "http://tandoor:80"
  script:
    - echo "üöÄ –ó–∞–ø—É—Å–∫ API —Ç–µ—Å—Ç–æ–≤..."
    - source venv/bin/activate
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
    - |
      echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Tandoor API..."
      for i in {1..10}; do
        if curl -s -f http://tandoor:80/api/health/ > /dev/null; then
          echo "‚úÖ Tandoor API –¥–æ—Å—Ç—É–ø–µ–Ω"
          break
        fi
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Tandoor API... ($i/10)"
        sleep 10
      done
    # –ó–∞–ø—É—Å–∫–∞–µ–º API —Ç–µ—Å—Ç—ã
    - echo "üîÑ –ó–∞–ø—É—Å–∫ pytest –¥–ª—è API —Ç–µ—Å—Ç–æ–≤..."
    - echo "BASE_URL = $BASE_URL"
    - echo "TANDOOR_TOKEN (–ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤): ${TANDOOR_TOKEN:0:10}..."
    - pytest tests/ -m api -v --alluredir=allure-results-api
    - echo "‚úÖ API —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"
  artifacts:
    when: always
    paths:
      - allure-results-api/
    expire_in: 1 week
  dependencies:
    - prepare_environment

# ------------------------------------------------------------
# 3. UI –¢–ï–°–¢–´
# ------------------------------------------------------------
ui_tests:
  stage: test_ui
  <<: *default_job
  services:
    - name: vabene1111/recipes:latest
      alias: tandoor
    - name: selenium/standalone-chrome:latest
      alias: selenium
  variables:
    BASE_URL: "http://tandoor:80"
    SELENIUM_HOST: "selenium"
  script:
    - echo "üöÄ –ó–∞–ø—É—Å–∫ UI —Ç–µ—Å—Ç–æ–≤..."
    - source venv/bin/activate
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤
    - |
      echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤..."
      for i in {1..15}; do
        if curl -s -f http://tandoor:80/api/health/ > /dev/null; then
          echo "‚úÖ Tandoor –¥–æ—Å—Ç—É–ø–µ–Ω"
          break
        fi
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Tandoor... ($i/15)"
        sleep 5
      done
      
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º Selenium
      for i in {1..10}; do
        if curl -s -f http://selenium:4444/wd/hub/status > /dev/null; then
          echo "‚úÖ Selenium –¥–æ—Å—Ç—É–ø–µ–Ω"
          break
        fi
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Selenium... ($i/10)"
        sleep 3
      done
    # –ó–∞–ø—É—Å–∫–∞–µ–º UI —Ç–µ—Å—Ç—ã
    - echo "üîÑ –ó–∞–ø—É—Å–∫ pytest –¥–ª—è UI —Ç–µ—Å—Ç–æ–≤..."
    - echo "BASE_URL = $BASE_URL"
    - echo "SELENIUM_HOST = $SELENIUM_HOST"
    - pytest tests/ -m ui -v --alluredir=allure-results-ui
    - echo "‚úÖ UI —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"
  artifacts:
    when: always
    paths:
      - allure-results-ui/
    expire_in: 1 week
  dependencies:
    - prepare_environment

# ------------------------------------------------------------
# 4. –ì–ï–ù–ï–†–ê–¶–ò–Ø ALLURE –û–¢–ß–ï–¢–ê
# ------------------------------------------------------------
generate_allure_report:
  stage: generate_report
  image: frankescobar/allure-docker-service
  needs: ["api_tests", "ui_tests"]
  script:
    - echo "üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure –æ—Ç—á–µ—Ç–∞..."
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
    - mkdir -p allure-results
    - cp -r allure-results-api/* allure-results/ 2>/dev/null || echo "–ù–µ—Ç API —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
    - cp -r allure-results-ui/* allure-results/ 2>/dev/null || echo "–ù–µ—Ç UI —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
    - allure generate allure-results --clean -o public/allure-report
    # –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    - |
      echo "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤:" > public/test_stats.txt
      echo "=====================" >> public/test_stats.txt
      date >> public/test_stats.txt
      echo "" >> public/test_stats.txt
      if [ -d "allure-results-api" ]; then
        echo "API —Ç–µ—Å—Ç—ã:" >> public/test_stats.txt
        find allure-results-api -name "*.json" | wc -l | xargs echo "  –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤: " >> public/test_stats.txt