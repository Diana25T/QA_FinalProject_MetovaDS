stages:
  - test_api
  - test_ui
  - report
  - deploy

variables:
  BASE_URL: "http://tandoor:80"
  SELENIUM_HOST: "selenium"  # Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾: Ð±ÐµÐ· Ð´Ð²Ð¾Ð¹Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð´Ñ‡ÐµÑ€ÐºÐ¸Ð²Ð°Ð½Ð¸Ñ

api_tests:
  stage: test_api
  image: python:3.11-slim
  services:
    - name: vabene1111/recipes:latest
      alias: tandoor
  script:
    - echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº API Ñ‚ÐµÑÑ‚Ð¾Ð²..."
    - pip install -r requirements.txt
    - echo "BASE_URL = $BASE_URL"

    # Ð£Ð’Ð•Ð›Ð˜Ð§Ð˜Ð’ÐÐ•Ðœ Ð’Ð Ð•ÐœÐ¯ ÐžÐ–Ð˜Ð”ÐÐÐ˜Ð¯ - Tandoor Ð´Ð¾Ð»Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ
    - echo "â³ ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Tandoor (Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð´Ð¾ 3 Ð¼Ð¸Ð½ÑƒÑ‚)..."
    - |
      for i in {1..36}; do
        if curl -s -f "http://tandoor:80/api/" > /dev/null 2>&1; then
          echo "âœ… Tandoor API Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð³Ð¾Ñ‚Ð¾Ð² (Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° $i/36)"
          break
        elif [ $i -eq 36 ]; then
          echo "âŒ Tandoor API Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ Ð·Ð° 3 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹"
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾:"
          curl -I "http://tandoor:80/" || echo "Ð¡ÐµÑ€Ð²ÐµÑ€ Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚"
          exit 1
        else
          echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ... ($i/36) - 5 ÑÐµÐºÑƒÐ½Ð´"
          sleep 5
        fi
      done

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health endpoint
    - echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health endpoint..."
    - curl -s "http://tandoor:80/api/health/" | head -20 || echo "Health check Ð½Ðµ Ð¿Ñ€Ð¾ÑˆÐµÐ»"

    - pytest tests/ -m api -v --alluredir=allure-results

ui_tests:
  stage: test_ui
  image: python:3.11-slim
  services:
    - name: vabene1111/recipes:latest
      alias: tandoor
    - name: selenium/standalone-chrome:latest
      alias: selenium  # Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾: Ð´Ð¾Ð»Ð¶Ð½Ð¾ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°Ñ‚ÑŒ Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹
  script:
    - echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº UI Ñ‚ÐµÑÑ‚Ð¾Ð²..."
    - pip install -r requirements.txt
    - echo "BASE_URL = $BASE_URL"
    - echo "SELENIUM_HOST = $SELENIUM_HOST"

    # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
    - echo "â³ ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸ÑÑ‹..."
    # Ð–Ð´ÐµÐ¼ Tandoor
    - timeout 180 bash -c 'until curl -s -f http://tandoor:80/api/ > /dev/null; do sleep 10; echo "Ð–Ð´ÐµÐ¼ Tandoor..."; done'
    # Ð–Ð´ÐµÐ¼ Selenium
    - timeout 60 bash -c 'until curl -s -f http://selenium:4444/wd/hub/status > /dev/null; do sleep 5; echo "Ð–Ð´ÐµÐ¼ Selenium..."; done'

    - pytest tests/ -m ui -v --alluredir=allure-results

generate_report:
  stage: report
  image: frankescobar/allure-docker-service
  script:
    - allure generate allure-results --clean -o public
  artifacts:
    paths:
      - public