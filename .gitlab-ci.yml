# Используем образ с Python
image: python:3.11-slim

# Определяем этапы пайплайна по порядку
stages:
  - prepare
  - test_api
  - test_ui
  - report

# Кэшируем pip-пакеты для ускорения
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cache/pip

# ШАГ 1: ПОДГОТОВКА. Создаем виртуальное окружение и ставим зависимости
prepare:
  stage: prepare
  script:
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install -r requirements.txt pytest selenium requests allure-pytest pytest-html webdriver-manager
  artifacts:
    paths:
      - venv/ # Сохраняем окружение для следующих этапов
    expire_in: 1 hour

# ШАГ 2: API-ТЕСТЫ. Запускаем тесты с пометкой 'api'
api_tests:
  stage: test_api
  script:
    - source venv/bin/activate
    - pytest tests/ -m api -v --alluredir=allure-results
  artifacts:
    when: always
    paths:
      - allure-results/ # Сохраняем сырые данные для Allure
    expire_in: 1 week
  dependencies:
    - prepare # Ждем завершения этапа подготовки

# ШАГ 3: UI-ТЕСТЫ. Используем Selenium в Docker и запускаем UI-тесты
ui_tests:
  stage: test_ui
  image: selenium/standalone-chrome:latest # Контейнер с браузером
  variables:
    BASE_URL: $BASE_URL # Передаем переменную из настроек CI
  script:
    - apt-get update && apt-get install -y python3-pip
    - pip3 install -r requirements.txt
    - python3 -m pytest tests/ -m ui -v --alluredir=allure-results-ui
  artifacts:
    when: always
    paths:
      - allure-results-ui/
      - screenshots/ # Сохраняем скриншоты падений
    expire_in: 1 week

# ШАГ 4: ГЕНЕРАЦИЯ И ПУБЛИКАЦИЯ ОТЧЕТА
generate_allure_report:
  stage: report
  script:
    # Устанавливаем Allure
    - apt-get update && apt-get install -y default-jre
    - wget https://github.com/allure-framework/allure2/releases/download/2.28.0/allure-2.28.0.tgz
    - tar -xzf allure-2.28.0.tgz -C /opt/
    - ln -s /opt/allure-2.28.0/bin/allure /usr/bin/allure
    # Генерируем отчет из результатов API и UI тестов
    - allure generate allure-results allure-results-ui --clean -o public
  artifacts:
    paths:
      - public/ # Папка с готовым HTML-отчетом
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == "main" # Публикуем отчет только для ветки main