# .gitlab-ci.yml
image: python:3.11

variables:
  BASE_URL:  "$BASE_URL"
  API_TOKEN: "$TANDOOR_TOKEN"
  ALLURE_RESULTS: "allure-results"
  ALLURE_REPORT: "public"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  CI: "true"

cache:
  paths:
    - .cache/pip
    - .venv/
  key: "${CI_COMMIT_REF_SLUG}"

stages:
  - setup
  - test
  - report
  - deploy

setup-environment:
  stage: setup
  script:
    - echo "=== ПОДГОТОВКА ОКРУЖЕНИЯ ==="
    - echo "BASE_URL:$BASE_URL"
    - echo "API_TOKEN доступен:${API_TOKEN:0:10}..."
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install allure-pytest pytest
  artifacts:
    paths:
      - .venv/
    expire_in: 1 hour

test-api:
  stage: test
  needs: ["setup-environment"]
  script:
    - echo "=== ЗАПУСК API ТЕСТОВ ==="
    - echo "Используем токен:${API_TOKEN:0:10}..."
    - source .venv/bin/activate
    - mkdir -p $ALLURE_RESULTS
    - python -m pytest tests/ -m api -v --alluredir=$ALLURE_RESULTS
  artifacts:
    paths:
      - $ALLURE_RESULTS/
    expire_in: 1 week

test-ui:
  stage: test
  needs: ["setup-environment"]
  before_script:
    - source .venv/bin/activate
  script:
    - echo "=== ЗАПУСК UI ТЕСТОВ ==="

    # УСТАНАВЛИВАЕМ CHROME БЕЗ apt-key
    - echo "Устанавливаем Chrome..."
    - apt-get update

    # Устанавливаем необходимые пакеты
    - apt-get update
    - apt-get install -y wget

    # Скачиваем ключ Google Chrome
    - wget -q -O google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - apt-get install -y ./google-chrome.deb
    - echo "Chrome version:"
    - google-chrome --version || echo "Chrome не установлен"
    - pip install webdriver-manager selenium
    - mkdir -p screenshots
    - mkdir -p $ALLURE_RESULTS

    # Запускаем UI тесты
    - python -m pytest tests/ -m ui -v --alluredir=$ALLURE_RESULTS

    - echo "UI тестирование завершено"
  artifacts:
    when: always
    paths:
      - $ALLURE_RESULTS/
      - screenshots/
    expire_in: 1 week

generate-report:
  stage: report
  needs: ["test-api", "test-ui"]
  script:
    - echo "=== ГЕНЕРАЦИЯ ALLURE ОТЧЕТОВ ==="
    - apt-get update
    - apt-get install -y default-jre-headless wget unzip
    - wget https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.zip
    - unzip allure-2.29.0.zip -d /opt/
    - ln -s /opt/allure-2.29.0/bin/allure /usr/bin/allure
    - allure generate $ALLURE_RESULTS -o $ALLURE_REPORT --clean
  artifacts:
    paths:
      - $ALLURE_REPORT/
  only:
    - main

pages:
  stage: deploy
  needs: ["generate-report"]
  script:
    - mkdir -p public
    - cp -r $ALLURE_REPORT/* public/
  artifacts:
    paths:
      - public
  only:
    - main